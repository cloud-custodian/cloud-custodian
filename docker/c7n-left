FROM cgr.dev/chainguard/python:latest-dev as builder

WORKDIR /app


RUN python -m venv $HOME/tools && \
    source $HOME/tools/bin/activate && \
    pip3 install poetry==1.4.0

ADD tools/c7n_left /app

RUN ~/tools/bin/poetry export -o requirements.txt
RUN pip3 install --user  -r requirements.txt
RUN pip3 install --user c7n

FROM cgr.dev/chainguard/python:3.11

WORKDIR /app

COPY --from=builder /home/nonroot/.local/lib/python3.11/site-packages /home/nonroot/.local/lib/python3.11/site-packages

COPY --from=builder /app/c7n_left /app/c7n_left

ENV PYTHONPATH=/app:$PYTHONPATH

ENTRYPOINT [ "python", "-m", "c7n_left.cli" ]