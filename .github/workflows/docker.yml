name: "Docker Build"
env:
  job_metadata: '
    {
      "c7n": {
        "custodian_image_var": "CUSTODIAN_C7N_IMAGE"
      },
      "c7n-org": {
        "custodian_image_var": "CUSTODIAN_C7NORG_IMAGE"
      },
      "mailer": {
        "custodian_image_var": "CUSTODIAN_MAILER_IMAGE"
      },
      "policystream": {
        "custodian_image_var": "CUSTODIAN_POLICYSTREAM_IMAGE"
      }
  }'


on:
  push:
    branches:
      - master
    tags:
      # todo: update for 1.0
      - 0.*

jobs:

  Publish:
    strategy:
      matrix:
        image:
          - c7n
          - c7n-org
          - mailer
          - policystream

    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: ${{ matrix.image }} build and push
        uses: ./.github/composites/docker-build-push
        env:
          HUB_USER: c7nbuild
          HUB_TOKEN: ${{ secrets.DOCKER_CI_HUB_TOKEN }}
        with:
          image: ${{ matrix.image }}
          name: "${{ matrix.image }}"
          custodian_image_var: "${{ fromJSON(env.job_metadata)[matrix.image]['custodian_image_var'] }}"
          push: true
          platform: "linux/arm64,linux/amd64"
