policies:
  - name: account-limit-manual
    resource: account
    filters:
      - type: service-limit
        services:
          - RDS
        limits: "DB snapshots per user"
        threshold: 50
    actions:
      - type: notify
        template: account-limit-rds-snapshot
        subject: "[custodian] ({{ account }}) - RDS Manual snapshot"
        from: cloudmaid@capitalone.com
        to:
          - tbd@example.com
          - owner-contact
          # todo sns arn for dba group
          # - sns:

  - name: db-off
    resource: rds
    filters:
      # databases must be running and available
      - DBInstanceStatus: available

      # Not for read replicas
      - ReadReplicaSourceDBInstanceIdentifier: absent
      # Not for aurora clusters
      - DBClusterIdentifer: absent

      # Filter by offhours on the given opt-in tag
      - type: offhour
        tag: RDSOffhours
        offhour: 19
        default_tz: est
    actions:
      - type: snapshot
      - type: delete
        skip-snapshot: true
      - type: notify


  - name: db-on
    resource: rds-snapshots
    filters:
      - type: onhour
        tag: RDSOffhours
        onhour: 8
        default_tz: est
    actions:
      - restore
      - type: notify

  - name: db-hibernate-trim-snapshots
    resource: rds-snapshots
    filters:
      - "tag:HiberateSnapshot": 3
---

# Code changes

- [ x]  register off hours filter for use with rds
- [ ] snapshot with additional tags
- [ ] wait synchronously snapshot (optionally)
- [ ] copy parameters group to tags on snapshot
- [ ] restore (use tag value from snapshot for option group)
