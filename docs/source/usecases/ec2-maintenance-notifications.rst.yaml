.. _ec2maintenancenotifications:

EC2 - Events / Maintenance Notifications
======================
This policy uses the health filter and lets you notify users 
if there are events on their instance(s). Note for your jinja 
template if the 'c7n:HealthEvent' key exists in the resource
dictionary, then there is an event in there. You can use the 
'Description' part of 'c7n:HealthEvent' to show the interesting details.

There is an example HealthEvent below:

>>> resource['c7n:HealthEvent']
[{u'Description': u"EC2 has detected degradation of the underlying hardware hosting your Amazon EC2 instance associated with this event in the us-east-1 region. Due to this degradation, your instance could already be unreachable. After 2017-12-25 04:00 UTC your instance, which has an EBS volume as the root device, will be stopped.\n\nYou can see more information on your instances that are scheduled for retirement in the AWS Management Console (https://console.aws.amazon.com/ec2/v2/home?region=us-east-1#Events)\n\n* How does this affect you?\nYour instance's root device is an EBS volume and the instance will be stopped after the specified retirement date. You can start it again at any time. Note that if you have EC2 instance store volumes attached to the instance, any data on these volumes will be lost when the instance is stopped or terminated as these volumes are physically attached to the host computer\n\n* What do you need to do?\nYou may still be able to access the instance. We recommend that you replace the instance by creating an AMI of your instance and launch a new instance from the AMI. For more information please see Amazon Machine Images (http://docs.aws.amazon.com/AWSEC2/latest/Us erGuide/AMIs.html) in the EC2 User Guide. In case of difficulties stopping your EBS-backed instance, please see the Instance FAQ (http://aws.amazon.com/instance-help/#ebs-stuck-stopping).\n\n* Why retirement?\nAWS may schedule instances for retirement in cases where there is an unrecoverable issue with the underlying hardware. For more information about scheduled retirement events please see the EC2 user guide (http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/instance-retirement.html). To avoid single points of failure within critical applications, please refer to our architecture center for more information on implementing fault-tolerant architectures: http://aws.amazon.com/architecture\n\nIf you have any questions or concerns, you can contact the AWS Support Team on the community forums and via AWS Premium Support at: http://aws.amazon.com/support", u'lastUpdatedTime': u'2017-12-10T20:24:36.473000-08:00', u'service': u'EC2', u'startTime': u'2017-12-24T20:00:00-08:00', u'eventTypeCategory': u'scheduledChange', u'eventTypeCode': u'AWS_EC2_PERSISTENT_INSTANCE_RETIREMENT_SCHEDULED', u'endTime': u'2017-12-24T20:00:00-08:00', u'region': u'us-east-1', u'arn': u'arn:aws:health:us-east-1::event/AWS_EC2_PERSISTENT_INSTANCE_RETIREMENT_SCHEDULED17e276aa-e0ef-4659-a635-c2067aa2fecd', u'statusCode': u'upcoming'}]



.. code-block:: yaml

   policies:
   
   - name: ec2-email-about-scheduled-maintenance
     resource: ec2
     mode:
       type: periodic
       role: arn:aws:iam::{account_id}:role/custodian-lambda-role
       schedule: rate(1 day)
     filters:
       - type: health-event
         statuses:
           - upcoming
           - open
         types:
           - AWS_EC2_API_ISSUE
           - AWS_EC2_BILLING_NOTIFICATION
           - AWS_EC2_CLASSIC_NETWORK_HEALTH_INTERNET_ISSUE
           - AWS_EC2_CLASSIC_NETWORK_HEALTH_INTER_AZ_ISSUE
           - AWS_EC2_CLASSIC_NETWORK_HEALTH_INTRA_AZ_ISSUE
           - AWS_EC2_DEDICATED_HOST_NETWORK_MAINTENANCE_SCHEDULED
           - AWS_EC2_DEDICATED_HOST_POWER_MAINTENANCE_SCHEDULED
           - AWS_EC2_DEDICATED_HOST_RETIREMENT_SCHEDULED
           - AWS_EC2_DEDICATED_HOST_UNDER_RESERVATION_REPLACE
           - AWS_EC2_DNS_RESOLUTION_ISSUE
           - AWS_EC2_INSTANCE_AUTO_RECOVERY_FAILURE
           - AWS_EC2_INSTANCE_AUTO_RECOVERY_NO_ACTION
           - AWS_EC2_INSTANCE_AUTO_RECOVERY_SUCCESS
           - AWS_EC2_INSTANCE_NETWORK_MAINTENANCE_SCHEDULED
           - AWS_EC2_INSTANCE_POWER_MAINTENANCE_SCHEDULED
           - AWS_EC2_INSTANCE_RETIREMENT_EXPEDITED
           - AWS_EC2_INSTANCE_RETIREMENT_SCHEDULED
           - AWS_EC2_INSTANCE_STORE_DRIVE_PERFORMANCE_DEGRADED
           - AWS_EC2_NETWORK_CONNECTIVITY_ISSUE
           - AWS_EC2_OPERATIONAL_ISSUE
           - AWS_EC2_OPERATIONAL_NOTIFICATION
           - AWS_EC2_PERSISTENT_INSTANCE_RETIREMENT_EXPEDITED
           - AWS_EC2_PERSISTENT_INSTANCE_RETIREMENT_SCHEDULED
           - AWS_EC2_POWER_CONNECTIVITY_ISSUE
           - AWS_EC2_RI_MARKETPLACE_BANK_ACCOUNT_UPDATE_REQUIRED
           - AWS_EC2_SYSTEM_REBOOT_MAINTENANCE_SCHEDULED
           - AWS_EC2_VPC_NETWORK_HEALTH_INTERNET_ISSUE
           - AWS_EC2_VPC_NETWORK_HEALTH_INTER_AZ_ISSUE
           - AWS_EC2_VPC_NETWORK_HEALTH_INTRA_AZ_ISSUE
     actions:
       - type: notify
         priority_header: '1'
         template_format: html
         email_ldap_username_manager: True
         template: /custodian/email/jinja_template.j2
         subject: "{{account}} - {{region}} - AWS EC2 resource(s) has an event!"
         to:
           - resource-owner
           - ldap_uid_tags
           - custodian@example.com
         transport:
           type: sqs
           queue: https://sqs.us-east-1.amazonaws.com/12345/cloudcustodian-mailer